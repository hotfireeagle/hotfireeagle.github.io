<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：123456const express = require(&apos;express&apos;);const morgan = require(&apos;morgan&apos;);const app = expre">
<meta name="keywords" content="nodejs">
<meta property="og:type" content="article">
<meta property="og:title" content="express">
<meta property="og:url" content="http://yoursite.com/2018/12/13/express/index.html">
<meta property="og:site_name" content="夜游">
<meta property="og:description" content="1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：123456const express = require(&apos;express&apos;);const morgan = require(&apos;morgan&apos;);const app = expre">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-12-16T13:31:09.594Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="express">
<meta name="twitter:description" content="1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：123456const express = require(&apos;express&apos;);const morgan = require(&apos;morgan&apos;);const app = expre">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>express</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/hotfireeagle">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/12/13/elasticsearch/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/12/13/express/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/12/13/express/&text=express"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/12/13/express/&is_video=false&description=express"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=express&body=Check out this article: http://yoursite.com/2018/12/13/express/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/12/13/express/&name=express&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。"><span class="toc-number">1.</span> <span class="toc-text">1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示："><span class="toc-number">2.</span> <span class="toc-text">2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then-以及catch-的参数。一个Promise只能够被决议一次。"><span class="toc-number">3.</span> <span class="toc-text">3.实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then()以及catch()的参数。一个Promise只能够被决议一次。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-express中间件的形式形如下面这样："><span class="toc-number">4.</span> <span class="toc-text">4.express中间件的形式形如下面这样：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-一些不可错过的中间件之静态文件中间件："><span class="toc-number">5.</span> <span class="toc-text">5.一些不可错过的中间件之静态文件中间件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-路由：routing-is-a-way-to-map-requests-to-specific-handlers-depending-on-their-URL-and-HTTP-verb。"><span class="toc-number">6.</span> <span class="toc-text">6.路由：routing is a way to map requests to specific handlers depending on their URL and HTTP verb。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-重定向："><span class="toc-number">7.</span> <span class="toc-text">7.重定向：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-发文件："><span class="toc-number">8.</span> <span class="toc-text">8.发文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）："><span class="toc-number">9.</span> <span class="toc-text">9.获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-获取请求头中的某个字段的值："><span class="toc-number">10.</span> <span class="toc-text">10.获取请求头中的某个字段的值：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-视图（采用ejs视图为例）："><span class="toc-number">11.</span> <span class="toc-text">11.视图（采用ejs视图为例）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-让所有视图都可以使用某个数据-将这个数据挂载到app-locals下面即可-："><span class="toc-number">12.</span> <span class="toc-text">12.让所有视图都可以使用某个数据(将这个数据挂载到app.locals下面即可)：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-res-end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。"><span class="toc-number">13.</span> <span class="toc-text">13.res.end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-Express中的middleware-stack"><span class="toc-number">14.</span> <span class="toc-text">14.Express中的middleware stack</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        express
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">夜游</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-12-13T14:11:01.000Z" itemprop="datePublished">2018-12-13</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/nodejs/">nodejs</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="1-express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。"><a href="#1-express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。" class="headerlink" title="1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。"></a>1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。</h3><h3 id="2-express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示："><a href="#2-express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：" class="headerlink" title="2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示："></a>2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(morgan(<span class="string">'dev'</span>));</span><br></pre></td></tr></table></figure>
<h3 id="3-实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then-以及catch-的参数。一个Promise只能够被决议一次。"><a href="#3-实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then-以及catch-的参数。一个Promise只能够被决议一次。" class="headerlink" title="3.实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then()以及catch()的参数。一个Promise只能够被决议一次。"></a>3.实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then()以及catch()的参数。一个Promise只能够被决议一次。</h3><h3 id="4-express中间件的形式形如下面这样："><a href="#4-express中间件的形式形如下面这样：" class="headerlink" title="4.express中间件的形式形如下面这样："></a>4.express中间件的形式形如下面这样：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleWare</span>(<span class="params">request, response, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do stuff with request and/or response</span></span><br><span class="line">  next(); <span class="comment">// when our middleware done,call the next middleWare to do work</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你甚至可以创建一些下面这种没意思但是有趣的middleware</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(i, req.method, req.url); <span class="comment">// 打印请求</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// a joke</span></span><br><span class="line">  <span class="keyword">let</span> second = <span class="keyword">new</span> <span class="built_in">Date</span>().getSeconds();</span><br><span class="line">  <span class="keyword">if</span> (second % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.status(<span class="number">403</span>).json(&#123;<span class="string">"from_me"</span>: <span class="string">"403 forbidden"</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="5-一些不可错过的中间件之静态文件中间件："><a href="#5-一些不可错过的中间件之静态文件中间件：" class="headerlink" title="5.一些不可错过的中间件之静态文件中间件："></a>5.一些不可错过的中间件之静态文件中间件：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(PUBLIC_PATH));</span><br></pre></td></tr></table></figure>
<p>关于express.static中间件有一个需要注意的问题就是，当这个中间件进行了有效的服务的话（指分发了静态资源），那么它将会阻止中间件 chain，相当于不会调用next；但是如果没有匹配到需要分发的静态资源的话，那么会调用next，将执行权利继续交给下一个midlleware。所以最佳实践是将静态资源中间件放在后面的适当位置（自然是要放在404 middleware前面的）。</p>
<h3 id="6-路由：routing-is-a-way-to-map-requests-to-specific-handlers-depending-on-their-URL-and-HTTP-verb。"><a href="#6-路由：routing-is-a-way-to-map-requests-to-specific-handlers-depending-on-their-URL-and-HTTP-verb。" class="headerlink" title="6.路由：routing is a way to map requests to specific handlers depending on their URL and HTTP verb。"></a>6.路由：routing is a way to map requests to specific handlers depending on <strong>their URL and HTTP verb</strong>。</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/hello/:who'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.end(<span class="string">`&lt;h1&gt;hello <span class="subst">$&#123;req.params.who&#125;</span>&lt;/h1&gt;`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="7-重定向："><a href="#7-重定向：" class="headerlink" title="7.重定向："></a>7.重定向：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/redirect'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.redirect(<span class="string">'/index'</span>); <span class="comment">// 站内重定向，或者像下面这样，重定向到其他站点</span></span><br><span class="line">  <span class="comment">// res.redirect('http://www.expressjs.com');</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="8-发文件："><a href="#8-发文件：" class="headerlink" title="8.发文件："></a>8.发文件：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filePath = path.resolve(__dirname, <span class="string">'somePath'</span>);</span><br><span class="line">app.get(<span class="string">'/file'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.sendFile(filePath); <span class="comment">// 需要注意的是并不会触发下载操作</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="9-获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）："><a href="#9-获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）：" class="headerlink" title="9.获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）："></a>9.获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.ip, req.method, req.url);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="10-获取请求头中的某个字段的值："><a href="#10-获取请求头中的某个字段的值：" class="headerlink" title="10.获取请求头中的某个字段的值："></a>10.获取请求头中的某个字段的值：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.ip, req.method, req.url, req.get(<span class="string">'Accept-Language'</span>));</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="11-视图（采用ejs视图为例）："><a href="#11-视图（采用ejs视图为例）：" class="headerlink" title="11.视图（采用ejs视图为例）："></a>11.视图（采用ejs视图为例）：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.resolve(__dirname, <span class="string">'VIEWS_PATH'</span>));              <span class="comment">// 第一步设置视图文件所在的文件位置</span></span><br><span class="line">app.set(<span class="string">'view engine'</span>,<span class="string">'ejs'</span>);                                         <span class="comment">// 设置视图引擎为EJS</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123;<span class="attr">message</span> : <span class="string">'ejs template'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// VIEWS_PATH/index.ejs</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span> /&gt;</span><br><span class="line">    &lt;title&gt;ejs&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;%= message %&gt;</span><br><span class="line">  &lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="12-让所有视图都可以使用某个数据-将这个数据挂载到app-locals下面即可-："><a href="#12-让所有视图都可以使用某个数据-将这个数据挂载到app-locals下面即可-：" class="headerlink" title="12.让所有视图都可以使用某个数据(将这个数据挂载到app.locals下面即可)："></a>12.让所有视图都可以使用某个数据(将这个数据挂载到app.locals下面即可)：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.locals.allCanUse = <span class="string">'all the views template can use this me'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="13-res-end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。"><a href="#13-res-end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。" class="headerlink" title="13.res.end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。"></a>13.res.end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。</h3><h3 id="14-Express中的middleware-stack"><a href="#14-Express中的middleware-stack" class="headerlink" title="14.Express中的middleware stack"></a>14.Express中的middleware stack</h3><p>首先有很重要的一点需要明白，那就是express是基于node进行处理的，前面也提到了，node处理输入并作出响应可以被抽象为对req object以及res object的处理，node把每个网络中传输过来的二进制请求转换为JavaScript object，当我们做好了响应后，使用res.end便又把响应数据发送给了客户端。在原生的node里面，这两个对象在一个函数过程里面进行处理。而在express中，req，res这两个对象是经由一系列的函数数组进行处理的，这个函数数组便叫做middleware stack了。具体过程便是：1.请求到达node server-&gt;2.交接给express APP进行处理-&gt;3.express中middleware stack中的每一个函数对请求进行处理-&gt;4.处理好了之后将结果返回给node server-&gt;5.发回给客户。</p>
<p>middleware stack中的每一个函数都接受三个参数，其中前两个分别是req和res，他们都是node server产生的，当然express在两个对象的基础上进行了一些增强。第三个参数就是next，是一个函数类型的变量。</p>
<p>当处理好了响应（响应数据已经可以发送给客户端了）的时候，调用res.end方法即可；当然在express中，我们也可以通过调用其他方法比如说res.send和res.sendFile或者json等，无论如何，上面这些提到的方法都将调用res.end。</p>
<p>对于一个中间件来说，下面两个动作必须执行其中的某一个，否则会发生错误（比如请求一直被挂起）。两个动作分别如下所示：</p>
<ul>
<li>1.作出响应，具体来说就是调用res.end或者res.send,以及res.sendFile等；</li>
<li>2.调用next()将执行权利交出去，让middleware stack中的下一个函数执行；</li>
</ul>
<p><strong>15.错误中间件，错误中间件具有四个参数，按照顺序来分别是(err, req, res, next)。如果在某个正常的中间件中，调用next方法的时候传入了一个Error参数的话，那么当这个中间件执行完后，接下来执行的中间件有可能就不是下一个中间件了，而是下一个错误捕获中间件。并且错误中间件也能够调用next方法，同理，如果往next里面传入了一个错误参数的话那么也是跳到最近的下一个错误中间件。举个例子：假如有A,B,C,D,E,F这六个中间件，其中中间件C和中间件E都是错误中间件的话，那么当在执行B中间件的时候如果next的参数是一个error的话，那么执行权就到了最近的下一个错误捕获中间件C，如果继续在中间件C中的next方法传入一个error参数的话，那么执行权就又到了E错误中间件。</strong></p>
<p><strong>16.路由：express能够根据HTTP动作和请求资源将请求链接到相应的controller上面。</strong></p>
<p>动态路由匹配使用下面这种模式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/users/:userId'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// do some stuff</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>类似于上面这样的路由能够动态匹配到/users/123和/users/ebooks等类似的；但是对于像下面这样的路由是匹配不到的：/users/或者/users/123/photo等类似的。</p>
<p><strong>17.动态路由匹配之使用正则表达式</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="regexp">/^\/users\/(\d+)$/</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> userId = <span class="built_in">parseInt</span>(req.params[<span class="number">0</span>], <span class="number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>对于上面这个例子来说，我们定义的正则表达式所表达的意思是指：必须是以/users开始，以一个数字或者多个数字结尾的路由；使用正则表达式来定义动态路由匹配和使用普通字符串来匹配路由有一个区别就是，正则表达式没有给动态内容命名，对于这种情况，express是这样处理的：利用索引进行访问，每个被正则表达式所匹配到的值都会顺序占据数组的一个位置。所以看看下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="regexp">/^\/users\/(\d+)-(\d+)$/</span>, (req, res) =&gt; &#123; <span class="comment">// 貌似一个圆括号是一个匹配单位</span></span><br><span class="line">  <span class="keyword">let</span> startId = <span class="built_in">parseInt</span>(req.params[<span class="number">0</span>], <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">let</span> endId = <span class="built_in">parseInt</span>(req.params[<span class="number">1</span>], <span class="number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>再看一个更加复杂的匹配要求，要求匹配 xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx，其中x是任意一个十六进制中的一个数，y是8，9，A，B中的某一个：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> reg = <span class="regexp">/^([0-9a-f]&#123;8&#125;-[0-9a-f]&#123;4&#125;-4[0-9a-f]&#123;3&#125;-[89AB][0-9a-f]&#123;3&#125;-[0-9a-f]&#123;12&#125;)$/i</span>;</span><br><span class="line">app.get(reg, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> uuid = req.params[<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>18.路由值查询字符串匹配</strong></p>
<p>先看一个正常的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// url像这样：/search?key=chaos</span></span><br><span class="line">app.get(<span class="string">'/search'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> key = req.query.key; <span class="comment">// 值是一个字符串</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>再看一个不太正常的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// url像这样：/search?key=oh&amp;key=no ; 糟糕的url设计</span></span><br><span class="line">app.get(<span class="string">'/search'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> keyArr = req.query.key; <span class="comment">// 由于两个query的键名一样，所以键值是一个数组！！！</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/hotfireeagle">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。"><span class="toc-number">1.</span> <span class="toc-text">1.express模块自身就是一个函数，而我们要做的就是利用这个函数去实例化出一个server对象。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示："><span class="toc-number">2.</span> <span class="toc-text">2.express被设计成了插件机制，如果你想实现什么功能的话，那么使用相对应的中间件即可。使用中间件的方法如下所示：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then-以及catch-的参数。一个Promise只能够被决议一次。"><span class="toc-number">3.</span> <span class="toc-text">3.实例化Promise对象时所传递的callback是立执行的。resolve以及reject中的参数将会作为then()以及catch()的参数。一个Promise只能够被决议一次。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-express中间件的形式形如下面这样："><span class="toc-number">4.</span> <span class="toc-text">4.express中间件的形式形如下面这样：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-一些不可错过的中间件之静态文件中间件："><span class="toc-number">5.</span> <span class="toc-text">5.一些不可错过的中间件之静态文件中间件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-路由：routing-is-a-way-to-map-requests-to-specific-handlers-depending-on-their-URL-and-HTTP-verb。"><span class="toc-number">6.</span> <span class="toc-text">6.路由：routing is a way to map requests to specific handlers depending on their URL and HTTP verb。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-重定向："><span class="toc-number">7.</span> <span class="toc-text">7.重定向：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-发文件："><span class="toc-number">8.</span> <span class="toc-text">8.发文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）："><span class="toc-number">9.</span> <span class="toc-text">9.获取访问ip（利用这个功能很容易实现拦截指定IP用户访问站点）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-获取请求头中的某个字段的值："><span class="toc-number">10.</span> <span class="toc-text">10.获取请求头中的某个字段的值：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-视图（采用ejs视图为例）："><span class="toc-number">11.</span> <span class="toc-text">11.视图（采用ejs视图为例）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-让所有视图都可以使用某个数据-将这个数据挂载到app-locals下面即可-："><span class="toc-number">12.</span> <span class="toc-text">12.让所有视图都可以使用某个数据(将这个数据挂载到app.locals下面即可)：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-res-end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。"><span class="toc-number">13.</span> <span class="toc-text">13.res.end表明node已经处理好了响应对象，是时候将响应对象发送给客户端了。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-Express中的middleware-stack"><span class="toc-number">14.</span> <span class="toc-text">14.Express中的middleware stack</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/12/13/express/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/12/13/express/&text=express"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/12/13/express/&is_video=false&description=express"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=express&body=Check out this article: http://yoursite.com/2018/12/13/express/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/12/13/express/&title=express"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/12/13/express/&name=express&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 hahahai
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/hotfireeagle">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


